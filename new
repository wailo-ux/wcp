var token = "8075574862:AAGz41b0GS-mtwXr_O4ENXqS8WLp9TOru34";
var folderId = "ID_FOLDER_DRIVE_ANDA";

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  if (!data.message) return;

  var message = data.message;
  var sender = message.from.first_name || message.from.id;
  var text = message.caption || message.text || "";
  var waktu = new Date();
  var rentangMenit = 5; 

  // 1. Setup Header
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["TIME STAMP", "SENDER", "LOKASI", "TSS (NOMINAL)", "TAWAS (KARUNG)", "FOTO 1", "FOTO 2", "FOTO 3", "FOTO 4"]);
    sheet.getRange("A1:I1").setFontWeight("bold").setBackground("#d9ead3").setHorizontalAlignment("center");
  }

  var lowerText = text.toLowerCase();
  var fileId = "";

  // 2. Simpan Foto ke Drive
  if (message.photo) {
    var photoId = message.photo[message.photo.length - 1].file_id;
    var fileUrl = getTelegramFileUrl(photoId);
    var blob = UrlFetchApp.fetch(fileUrl).getBlob();
    var file = DriveApp.getFolderById(folderId).createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    fileId = file.getId();
  }

  var lastRow = sheet.getLastRow();
  var isTss = lowerText.startsWith("#tss");
  var isTawas = lowerText.startsWith("#tawas");

  // LOGIKA: CEK APAKAH HARUS UPDATE KE KANAN
  if (lastRow > 1) {
    var lastWaktu = new Date(sheet.getRange(lastRow, 1).getValue());
    var lastSender = sheet.getRange(lastRow, 2).getValue();
    var selisih = (waktu - lastWaktu) / 1000 / 60;

    // Jika pengirim sama dan masih dalam rentang waktu yang sama
    if (lastSender == sender && selisih < rentangMenit) {
      
      // Ambil rumus IMAGE
      var rumusImg = '=IMAGE("https://drive.google.com/uc?export=view&id=' + fileId + '")';

      // Cari kolom kosong pertama mulai dari kolom 6 (FOTO 1) ke kanan
      var barisData = sheet.getRange(lastRow, 1, 1, 20).getValues()[0]; // Ambil 20 kolom
      var kolomKosong = 6;
      for (var i = 5; i < barisData.length; i++) {
        if (barisData[i] == "" || barisData[i] == "-") {
          kolomKosong = i + 1;
          break;
        }
      }

      // Update nominal TSS atau TAWAS jika ada teks baru
      if (isTss) {
        var nominal = text.split(" ")[2] || "-";
        sheet.getRange(lastRow, 4).setValue(nominal);
      }
      if (isTawas) {
        var jml = text.replace(/#tawas/i, "").trim() || "1";
        sheet.getRange(lastRow, 5).setValue(jml);
      }

      // Taruh foto di kolom kosong sebelah kanan
      if (fileId) {
        sheet.getRange(lastRow, kolomKosong).setFormula(rumusImg);
        sheet.setColumnWidth(kolomKosong, 300);
      }
      return;
    }
  }

  // 3. Jika Sesi Baru (#TSS pertama)
  if (isTss) {
    var parts = text.split(" ");
    var lokasi = parts[1] || "WTP";
    var nominal = parts[2] || "-";
    var rumusImg = fileId ? '=IMAGE("https://drive.google.com/uc?export=view&id=' + fileId + '")' : "-";
    
    sheet.appendRow([waktu, sender, lokasi, nominal, "-", rumusImg]);
    
    var row = sheet.getLastRow();
    sheet.setRowHeight(row, 300);
    sheet.setColumnWidth(6, 300);
    sheet.getRange(row, 1, 1, 9).setBorder(true, true, true, true, true, true)
         .setVerticalAlignment("middle").setHorizontalAlignment("center");
  }
}

function getTelegramFileUrl(fileId) {
  var response = UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/getFile?file_id=" + fileId);
  var filePath = JSON.parse(response.getContentText()).result.file_path;
  return "https://api.telegram.org/file/bot" + token + "/" + filePath;
}
