var token = "8075574862:AAGz41b0GS-mtwXr_O4ENXqS8WLp9TOru34";
var folderId = "ID_FOLDER_DRIVE_ANDA";

var token = "ISI_TOKEN_TELEGRAM_ANDA";
var folderId = "ID_FOLDER_DRIVE_ANDA";

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  if (!data || !data.message) return;

  var message = data.message;
  var sender = message.from.first_name || message.from.id;
  var text = (message.caption || message.text || "").trim();
  var waktu = new Date();

  // 1. Parsing Command & Lokasi
  // Menggunakan regex \s+ untuk menangani spasi ganda agar angka tidak terpotong
  var parts = text.split(/\s+/);
  var cmd = parts[0] ? parts[0].toLowerCase() : "";
  var lokasi = parts[1] ? parts[1].toUpperCase() : "";
  var nilai = parts[2] || ""; // Menangkap nominal seperti 500

  // LOGIKA PENTING: Jika foto kedua dari album datang tanpa teks,
  // kita izinkan lanjut agar bisa menempel ke baris sebelumnya.
  var isFotoLanjutan = (message.photo && text === "");
  if (!isFotoLanjutan && lokasi === "") return;

  // 2. Simpan Foto ke Drive
  var rumusImg = "";
  if (message.photo) {
    var photoId = message.photo[message.photo.length - 1].file_id;
    var fileUrl = getTelegramFileUrl(photoId);
    var blob = UrlFetchApp.fetch(fileUrl).getBlob();
    var file = DriveApp.getFolderById(folderId).createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    rumusImg = '=IMAGE("https://drive.google.com/uc?export=view&id=' + file.getId() + '")';
  }

  // 3. Cari Baris Terakhir (Berdasarkan Sesi/Waktu)
  var lastRow = sheet.getLastRow();
  var rowToUpdate = -1;
  
  if (lastRow > 1) {
    var rangeLook = (lastRow > 50) ? 50 : lastRow - 1;
    var dataRows = sheet.getRange(lastRow - rangeLook + 1, 1, rangeLook, 3).getValues();
    
    for (var i = dataRows.length - 1; i >= 0; i--) {
      var rowWaktu = new Date(dataRows[i][0]);
      var rowSender = dataRows[i][1];
      var selisihMenit = (waktu - rowWaktu) / 1000 / 60;

      // Jika pengirim sama dan masih dalam rentang 30 menit
      if (rowSender === sender && selisihMenit < 30) {
        rowToUpdate = (lastRow - rangeLook + 1) + i;
        break;
      }
    }
  }

  // 4. Eksekusi Update atau Baris Baru
  if (rowToUpdate !== -1) {
    // Jika foto tanpa teks, tempel ke kolom foto yang kosong di baris ini
    if (isFotoLanjutan) {
      isiKolomFotoOtomatis(sheet, rowToUpdate, rumusImg);
    } else {
      // Jika ada teks, update nilai nominal dan fotonya
      if (cmd === "#tss") {
        sheet.getRange(rowToUpdate, 3).setValue(lokasi);
        if (nilai !== "") sheet.getRange(rowToUpdate, 4).setValue(nilai);
        isiKolomFotoSpesifik(sheet, rowToUpdate, 6, 7, rumusImg);
      } else if (cmd === "#tawas") {
        sheet.getRange(rowToUpdate, 5).setValue(nilai);
        isiKolomFotoSpesifik(sheet, rowToUpdate, 8, 9, rumusImg);
      }
    }
  } else if (!isFotoLanjutan) {
    // Buat Baris Baru (Hanya jika ada command)
    var rowData = [waktu, sender, lokasi, (cmd==="#tss"?nilai:"-"), (cmd==="#tawas"?nilai:"-"), (cmd==="#tss"?rumusImg:""), "", (cmd==="#tawas"?rumusImg:""), ""];
    sheet.appendRow(rowData);
    formatBaris(sheet.getLastRow(), sheet);
  }
}

// Fungsi mengisi foto ke kolom kosong (Foto 1 atau Foto 2)
function isiKolomFotoSpesifik(sheet, row, c1, c2, img) {
  if (!img) return;
  if (sheet.getRange(row, c1).getValue() === "") {
    sheet.getRange(row, c1).setFormula(img);
  } else {
    sheet.getRange(row, c2).setFormula(img);
  }
}

// Fungsi cerdas untuk menempelkan foto album tanpa teks
function isiKolomFotoOtomatis(sheet, row, img) {
  if (!img) return;
  for (var col = 6; col <= 9; col++) {
    if (sheet.getRange(row, col).getValue() === "") {
      sheet.getRange(row, col).setFormula(img);
      break;
    }
  }
}

  // 4. LOGIKA PENCARIAN BARIS (Mencari Lokasi yang sama dalam 60 menit terakhir)
  if (lastRow > 1) {
    // Ambil data Lokasi (Kolom C) dan TimeStamp (Kolom A)
    var rangeData = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    // Cari dari baris paling bawah ke atas
    for (var i = rangeData.length - 1; i >= 0; i--) {
      var rowWaktu = new Date(rangeData[i][0]);
      var rowLokasi = rangeData[i][2].toString().toUpperCase().trim();
      var selisih = (waktu - rowWaktu) / 1000 / 60;

      // Jika Lokasi SAMA dan Waktu MASIH MASUK RENTANG
      if (rowLokasi === lokasiInput && selisih < rentangMenit) {
        rowToUpdate = i + 2; // +2 karena array mulai dari 0 dan header di baris 1
        break;
      }
    }
  }

  // 5. Eksekusi: Update baris lama atau buat baris baru
  if (rowToUpdate !== -1) {
    // UPDATE KE KANAN
    if (command === "#tss") {
      sheet.getRange(rowToUpdate, 4).setValue(nilaiInput);
      isiFotoKeKolom(sheet, rowToUpdate, 6, 7, rumusImg);
    } else if (command === "#tawas") {
      sheet.getRange(rowToUpdate, 5).setValue(nilaiInput);
      isiFotoKeKolom(sheet, rowToUpdate, 8, 9, rumusImg);
    }
  } else {
    // BUAT BARIS BARU
    var nominal = (command === "#tss") ? nilaiInput : "-";
    var karung = (command === "#tawas") ? nilaiInput : "-";
    var fTss = (command === "#tss") ? rumusImg : "";
    var fTawas = (command === "#tawas") ? rumusImg : "";
    
    sheet.appendRow([waktu, sender, lokasiInput, nominal, karung, fTss, "", fTawas, ""]);
    
    // Atur format baris baru
    var currentRow = sheet.getLastRow();
    sheet.setRowHeight(currentRow, 300);
    sheet.getRange(currentRow, 1, 1, 9).setBorder(true, true, true, true, true, true)
         .setVerticalAlignment("middle").setHorizontalAlignment("center");
    sheet.setColumnWidth(6, 300);
    sheet.setColumnWidth(7, 300);
    sheet.setColumnWidth(8, 300);
    sheet.setColumnWidth(9, 300);
  }
}

// Fungsi pembantu untuk mengisi kolom foto yang kosong
function isiFotoKeKolom(sheet, row, col1, col2, rumusImg) {
  if (!rumusImg) return;
  var sel1 = sheet.getRange(row, col1);
  var sel2 = sheet.getRange(row, col2);
  
  if (sel1.getValue() === "" || sel1.getValue() === "-") {
    sel1.setFormula(rumusImg);
  } else {
    sel2.setFormula(rumusImg);
  }
}

function getTelegramFileUrl(fileId) {
  var response = UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/getFile?file_id=" + fileId);
  var filePath = JSON.parse(response.getContentText()).result.file_path;
  return "https://api.telegram.org/file/bot" + token + "/" + filePath;
}

function setWebhook() {
  var webAppUrl = "URL_WEB_APP_ANDA"; 
  UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/setWebhook?url=" + webAppUrl);
}
