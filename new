var token = "ISI_TOKEN_TELEGRAM_ANDA";
var folderId = "ID_FOLDER_DRIVE_ANDA";

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  if (!data.message) return;

  var message = data.message;
  var sender = message.from.first_name || message.from.id;
  var text = message.caption || message.text || "";
  var waktu = new Date();
  var rentangMenit = 5; // Toleransi penggabungan foto tambahan

  // 1. Setup Header
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["TIME STAMP", "SENDER", "LOKASI", "TSS (NOMINAL)", "TAWAS (KARUNG)", "FOTO TSS", "FOTO PENAWASAN"]);
    sheet.getRange("A1:G1").setFontWeight("bold").setBackground("#d9ead3").setHorizontalAlignment("center");
    sheet.setColumnWidth(6, 300); 
    sheet.setColumnWidth(7, 300);
  }

  var lowerText = text.toLowerCase();
  var fileId = "";

  // 2. Proses Simpan Foto ke Drive
  if (message.photo) {
    var photoId = message.photo[message.photo.length - 1].file_id;
    var fileUrl = getTelegramFileUrl(photoId);
    var blob = UrlFetchApp.fetch(fileUrl).getBlob();
    var file = DriveApp.getFolderById(folderId).createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    fileId = file.getId();
  }

  var lastRow = sheet.getLastRow();
  var isTss = lowerText.startsWith("#tss");
  var isTawas = lowerText.startsWith("#tawas");

  // Logika Cek Baris Terakhir untuk Penggabungan Foto (Multi-foto)
  if (lastRow > 1) {
    var lastWaktu = new Date(sheet.getRange(lastRow, 1).getValue());
    var lastSender = sheet.getRange(lastRow, 2).getValue();
    var selisih = (waktu - lastWaktu) / 1000 / 60;

    if (lastSender == sender && selisih < rentangMenit) {
      // Jika kirim foto TSS tambahan (tanpa text baru atau hashtag sama)
      if (isTss || (message.photo && text == "")) {
         updateFotoSel(sheet, lastRow, 6, fileId);
         return;
      }
      // Jika kirim foto TAWAS tambahan
      if (isTawas) {
         var jml = text.replace(/#tawas/i, "").trim() || "1";
         sheet.getRange(lastRow, 5).setValue(jml);
         updateFotoSel(sheet, lastRow, 7, fileId);
         return;
      }
    }
  }

  // 3. Jika bukan penggabungan, buat baris baru (Untuk #TSS pertama)
  if (isTss) {
    var parts = text.split(" ");
    var lokasi = parts[1] || "WTP";
    var nominal = parts[2] || "-";
    var rumusImg = fileId ? '=IMAGE("https://drive.google.com/uc?export=view&id=' + fileId + '")' : "-";
    
    sheet.appendRow([waktu, sender, lokasi, nominal, "-", rumusImg, "-"]);
    formatBaru(sheet.getLastRow(), sheet);
  }
}

// Fungsi untuk menggabungkan banyak foto dalam satu sel
function updateFotoSel(sheet, row, col, newFileId) {
  if (!newFileId) return;
  var valLama = sheet.getRange(row, col).getFormula();
  var newImg = 'IMAGE("https://drive.google.com/uc?export=view&id=' + newFileId + '")';
  
  if (valLama == "" || valLama == "-") {
    sheet.getRange(row, col).setFormula("=" + newImg);
  } else {
    // Menggunakan teknik baris baru di dalam sel agar foto tersusun vertikal
    // Catatan: Google Sheets terbatas dalam menampilkan banyak IMAGE dalam satu sel, 
    // namun cara ini paling optimal untuk grouping.
    var cleanFormula = valLama.replace("=", "");
    sheet.getRange(row, col).setFormula("=" + cleanFormula + "& CHAR(10) &" + newImg);
  }
}

function formatBaru(row, sheet) {
  sheet.setRowHeight(row, 300);
  sheet.getRange(row, 1, 1, 7).setBorder(true, true, true, true, true, true)
       .setVerticalAlignment("middle").setHorizontalAlignment("center").setWrap(true);
}

function getTelegramFileUrl(fileId) {
  var response = UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/getFile?file_id=" + fileId);
  var filePath = JSON.parse(response.getContentText()).result.file_path;
  return "https://api.telegram.org/file/bot" + token + "/" + filePath;
}
